---
title: "mod6_hw1_st525_oursop"
author: "Philip Ourso"
date: "11/6/2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=F, message=F, warning=F}
library(colorspace)
library(directlabels)
library(hexbin)
library(km.ci)
library(RColorBrewer)
library(survival)
library(survminer)
library(tidyverse)
library(tidytext)
library(vtable)

```
## Module 6 HW1

1. Consider a two-group experiment...
  a. Use the Kaplan-Meier method to estimate the survival functions for the two groups separately.  
    The KM estimator survival functions are plotted below.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
df_1 = data.frame(
  time = c(c(123, 166, 188, 188, 192, 192, 201, 209, 213, 216, 216, 219, 230, 234, 246, 265, 304, 226, 244, 266), 
           c(142, 156, 163, 188, 215, 232, 232, 233, 233, 233, 236, 245, 261, 280, 280, 296, 299, 363, 204, 344)),
  status = c(rep(1, 17), rep(0,3), rep(1, 18), rep(0,2)),
  group = c(rep("A", 20), rep("B", 20))
)
#head(df_1)

df_A = df_1 %>%
  filter(group == "A" )

fit1 <- survfit(Surv(time, status) ~ 1, data = df_A)
ggsurvplot(fit = fit1, data = df_A, conf.int = TRUE)

df_B = df_1 %>%
  filter(group == "B" )

fit2 <- survfit(Surv(time, status) ~ 1, data = df_B)
ggsurvplot(fit = fit2, data = df_B, conf.int = TRUE)

```  

  b. Based on the Kaplan-Meier estimators, can Weibull distribution be a good fit to the survival data in either group? Please provide relevant graph to support your answer.    
    The log-negative-log plots vs log time are plotted below for both groups. Group A's curve has a slight "S" shape and group B's curve has several small steps, so neither are obviously strictly linear, but group A might be better fit by a Weibull regression model.
    
```{r, echo=FALSE, warning=FALSE, message=FALSE}    
table_A <- summary(fit1, times = c(0, unique(df_A$time)))

table_A <- data.frame(
  time = table_A$time, 
  survival = table_A$surv, 
  failure = 1-table_A$surv, 
  Survival.Std.Err = table_A$std.err, 
  No.Left = table_A$n.risk, 
  No.Failed = table_A$n.event, 
  No.Censored = table_A$n.censor
  )

#head(table_A, 25)
# retain only rows w/ events observed
table_A2 <- table_A[c(table_A$No.Failed > 0), ]
table_A2 <- data.frame(rbind(table_A[1, ], table_A2))
#head(table_A2, 25)

# plot -log(survival)
ggplot(data = table_A2) + 
  geom_line(aes(x = time, y = -log(survival))) +
  geom_point(aes(x = time, y = -log(survival)), size = 2, shape = 1) +
  labs(title = 'Negative Log of Estimated Group A Survivor Function') +
  ylab('-log(Survival Probability)') + xlab('time') #+

# plot -log(survival)
ggplot(data = table_A2[-(1),]) + 
  geom_line(aes(x = log(time), y = log(-log(survival)))) +
  geom_point(aes(x = log(time), y = log(-log(survival))), size = 2, shape = 1) +
  labs(title = 'Log Negative Log of Estimated Group A Survivor Function') +
  ylab('log[-log(Survival Probability)]') + xlab('log(time)') #+

#group B
table_B <- summary(fit2, times = c(0, unique(df_B$time)))

table_B <- data.frame(
  time = table_B$time, 
  survival = table_B$surv, 
  failure = 1-table_B$surv, 
  Survival.Std.Err = table_B$std.err, 
  No.Left = table_B$n.risk, 
  No.Failed = table_B$n.event, 
  No.Censored = table_B$n.censor
  )

#head(table_A, 25)
# retain only rows w/ events observed
table_B2 <- table_B[c(table_B$No.Failed > 0), ]
table_B2 <- data.frame(rbind(table_B[1, ], table_B2))
#head(table_A2, 25)

# plot -log(survival)
ggplot(data = table_B2) + 
  geom_line(aes(x = time, y = -log(survival))) +
  geom_point(aes(x = time, y = -log(survival)), size = 2, shape = 1) +
  labs(title = 'Negative Log of Estimated Group B Survivor Function') +
  ylab('-log(Survival Probability)') + xlab('time') #+
  #scale_x_continuous(limits = c(0, 35))

# plot -log(survival)
ggplot(data = table_B2[-(1),]) + 
  geom_line(aes(x = log(time), y = log(-log(survival)))) +
  geom_point(aes(x = log(time), y = log(-log(survival))), size = 2, shape = 1) +
  labs(title = 'Log Negative Log of Estimated Group B Survivor Function') +
  ylab('log[-log(Survival Probability)]') + xlab('log(time)') #+
  #scale_x_continuous(limits = c(0, 35))
```  
  
  c. Fit a Weibull distribution to the survival data for each group separately. Provide parameter estimates for the Weibull distributions.  
    Fitting a Weibull regression model to the groups individually results in the following parameters.  
    Group A:  
      alpha: 1/0.176 == 5.69  
      lambda: exp(-B0/ sigma) = 3.11e-14  
    Group B:  
      alpha: 1.0/0.224 == 4.46  
      lambda: 1.39e-11  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
fit_A <- survreg(formula = Surv(time, status) ~ 1,
                data = df_A, dist = 'weibull')
summary(fit_A)


fit_B <- survreg(formula = Surv(time, status) ~ 1,
                data = df_B, dist = 'weibull')
summary(fit_B)

```
  
  d. Plot the estimated survival curves from (a) and (c) in the same plot. Now access again if Weibull distribution is a good fit to the data.   
    Upon reviewing the overlay of each groups' estimated survival functions it can be seen that the Weibull regression model is a good fit for both groups.    
```{r, echo=FALSE, message=FALSE, warning=FALSE}
pct = seq(0.01, 0.99, by=0.01)
weib_pred_A = predict(fit_A, type = "quantile", p = pct, newdata=data.frame(1))

df_plot_A = data.frame(surv=weib_pred_A, pct = 1-pct)

#ggplot(data = df_plot_A) + 
#  geom_line(aes(x = surv, y = pct)) +
#  theme_minimal() + 
#  labs(
#    title = "Weibull Regression Model for Group A"
#  )


weib_pred_B = predict(fit_B, type = "quantile", p = pct, newdata=data.frame(1))

df_plot_B = data.frame(surv=weib_pred_B, pct = 1-pct)

#ggplot(data = df_plot_B) + 
#  geom_line(aes(x = surv, y = pct)) +
#  theme_minimal() + 
#  labs(
#    title = "Weibull Regression Model for Group B"
#  )

ggplotA = ggsurvplot(fit = fit1, data = df_A, conf.int = TRUE)$plot
ggplotA +
#  ggplotB +
  geom_line(aes(x = surv, y = pct), data=df_plot_A, color = "blue", linetype="dashed") +
  theme_minimal() + 
  labs(
    title = "Kaplan-Meier estimator and Weibull Regression Model for Group A"
  )

ggplotB = ggsurvplot(fit = fit2, data = df_B, conf.int = TRUE)$plot
ggplotB +
  geom_line(aes(x = surv, y = pct), data=df_plot_B, color = "blue", linetype="dashed") +
  theme_minimal() + 
  labs(
    title = "Kaplan-Meier Estimator and Weibull Regression Model for Group B"
  )

```
  
1. Let us consider...
    a. Form a 2x2 table and record the entries for each event time.  
        
            ti = 15  
               | di | ai |     
            -----------------  
            A  |    | 5  | 5       
            B  | 1  | 4  | 5      
            Tot| 1  | 9  | 10        
    
            ti = 18
               | di | ai |
            -----------------
            A  |    | 4  | 4   
            B  | 1  | 3  | 4
            Tot| 1  | 7  | 8     
    
            ti = 19
               | di | ai |
            -----------------
            A  |    | 3  | 3   
            B  | 2  | 1  | 3
            Tot| 2  | 4  | 6     
    
            ti = 20
               | di | ai |
            -----------------
            A  |    | 3  | 3   
            B  | 1  |    | 1
            Tot| 1  | 3  | 4     
    
            ti = 23
               | di | ai |
            -----------------
            A  | 1  | 1  | 2   
            B  |    |    |   
            Tot| 1  | 1  | 2     
          
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
df_1 = data.frame(
  ti = c(23, 16, 18, 20, 24, 15, 18, 19, 19, 20),
  ci = c(1,0,0,0,0,1,1,1,1,1),
  g  = c(rep('A', 5), rep('B', 5))
)
head(df_1, 10)

```
  
    b. For each table, compute the observed # of events, expected number of events, and variance for group A.  
        
            ti = 15  
               | di | ai |   | ei | vi       
            ----------------------------  
            A  | 0  | 5  | 5 |0.5 | 0.25         
            B  | 1  | 4  | 5 |    |           
            Tot| 1  | 9  | 10|    |             
    
            ti = 18
               | di | ai |   | ei | vi       
            ----------------------------
            A  |    | 4  | 4 | 0.5| 0.25          
            B  | 1  | 3  | 4 |    |            
            Tot| 1  | 7  | 8 |    |                 
    
            ti = 19
               | di | ai |   | ei | vi       
            ----------------------------
            A  |    | 3  | 3 | 1  | 0.4     
            B  | 2  | 1  | 3 |    |          
            Tot| 2  | 4  | 6 |    |               
    
            ti = 20
               | di | ai |   | ei | vi       
            ----------------------------
            A  |    | 3  | 3 |0.75| 0.1875            
            B  | 1  |    | 1 |    |          
            Tot| 1  | 3  | 4 |    |               
    
            ti = 23
               | di | ai |   | ei | vi       
            ----------------------------
            A  | 1  | 1  | 2 | 1  | 0            
            B  |    |    |   |    |          
            Tot| 1  | 1  | 2 |    |               
          
    c. Calculate the log-rank test statistic.  
              
            [(1 - 3.75) ^2] / 1.0875 == 6.954  
  
    d. Find the p-value and report your conclusion based on the test result.  
        The p-value is 0.0084, which is less than the alpha value of 0.05 and hence the null hypothesis of equal survival functions across groups is rejected.  
        
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
1-pchisq(6.954, df=1)

```
  
2. To compare two treatments...
    a. Form a 2x2 table and record the entries for each event time.  

            ti = 10  
               | di | ai |     
            -----------------  
            A  |    | 7  | 7       
            B  | 1  | 5  | 6      
            Tot| 1  | 12 | 13        
    
            ti = 14
               | di | ai |
            -----------------
            A  |    | 7  | 7   
            B  | 1  | 4  | 5
            Tot| 1  | 11 | 12     
    
            ti = 15
               | di | ai |
            -----------------
            A  |    | 7  | 7   
            B  | 1  | 3  | 4
            Tot| 1  | 10 | 11     
    
            ti = 16
               | di | ai |
            -----------------
            A  | 1  | 6  | 7   
            B  |    | 3  | 3
            Tot| 1  | 9  | 10     
    
            ti = 18
               | di | ai |
            -----------------
            A  |    | 5  | 5   
            B  | 1  | 2  | 3 
            Tot| 1  | 7  | 8     
    
            ti = 20
               | di | ai |
            -----------------
            A  | 1  | 2  | 3   
            B  |    | 1  | 1 
            Tot| 1  | 3  | 4     
    
            ti = 21
               | di | ai |
            -----------------
            A  |    | 2  | 2   
            B  | 1  |    | 1 
            Tot| 1  | 2  | 3     
    
            ti = 28
               | di | ai |
            -----------------
            A  | 1  | 1  | 2   
            B  |    |    |  
            Tot| 1  | 1  | 2     
          
    b. For each table, compute the observed # of events, expected number of events, and variance for group A.  
        
            ti = 10  
               | di | ai |   | ei | vi          
            ----------------------------  
            A  |    | 7  | 7 |0.54| 0.25                 
            B  | 1  | 5  | 6 |    |                 
            Tot| 1  | 12 | 13|    |                   
    
            ti = 14
               | di | ai |   | ei | vi          
            ----------------------------
            A  |    | 7  | 7 |0.58| 0.24 
            B  | 1  | 4  | 5
            Tot| 1  | 11 | 12     
    
            ti = 15
               | di | ai |   | ei | vi          
            ----------------------------
            A  |    | 7  | 7 |0.64| 0.23   
            B  | 1  | 3  | 4
            Tot| 1  | 10 | 11     
    
            ti = 16
               | di | ai |   | ei | vi          
            ----------------------------
            A  | 1  | 6  | 7 |0.7 | 0.21   
            B  |    | 3  | 3
            Tot| 1  | 9  | 10     
    
            ti = 18
               | di | ai |   | ei | vi          
            ----------------------------
            A  |    | 5  | 5 |0.63| 0.23   
            B  | 1  | 2  | 3 
            Tot| 1  | 7  | 8     
    
            ti = 20
               | di | ai |   | ei | vi          
            ----------------------------
            A  | 1  | 2  | 3 |0.75| 0.19   
            B  |    | 1  | 1 
            Tot| 1  | 3  | 4     
    
            ti = 21
               | di | ai |   | ei | vi          
            ----------------------------
            A  |    | 2  | 2 |0.67| 0.22   
            B  | 1  |    | 1 
            Tot| 1  | 2  | 3     
    
            ti = 28
               | di | ai |   | ei | vi          
            ----------------------------
            A  | 1  | 1  | 2 |  1 | 0   
            B  |    |    |  
            Tot| 1  | 1  | 2     
  
    c. Calculate the log-rank test statistic.  
              
            [(3 - 5.5) ^2] / 1.58 == 3.96  
  
    d. Find the p-value and report your conclusion based on the test result.  
        The p-value is 0.047, which is less than the alpha value of 0.05 and hence the null hypothesis of equal survival functions across groups is rejected.  
        
```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
1-pchisq(3.96, df=1)

```

3. A study was conducted...
    a. Import the data into SAS or R.  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
df_3 = read.csv("tongue.csv")
head(df_3)
```  
    b. In one figure, plot the KM estimates and their 95% point-wise CIs for patients with two different tumor types.  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(survival)
library(survminer)
#censored <- Surv(myel$dur, myel$status)
fit1 <- survfit(Surv(time, delta) ~ type, data = df_3)
ggsurvplot(fit = fit1, data = df_3, conf.int = TRUE)
```      
    c. Test the hypothesis that there is no difference in survival for patients in two tumor types. Clearly state the null and alternative hypotheses. Provide the test statistic and conclusions based on these results.  
    H0: there is no difference in survival functions between the two groups of cancer patients, those with aneuploid tumors and those with diploid tumors.  
    HA: there is a difference in survival functions between the two groups of cancer patients, those with aneuploid tumors and those with diploid tumors.  
    
    The log-rank test statistic is 2.8 based on 1 degree of freedom, resulting in a p-value of 0.09.  
    The Peto-Peto test statistic is 3.3 based on 1 degree of freedom, resulting in a p-value of 0.07.  
    
    Both test statistics are in agreement and we fail to reject the null hypothesis, concluding that there is no strong evidence to find that the survival functions of the groups are statistically different.  
```{r, echo=FALSE, warning=FALSE, message=FALSE}
logrank<-survdiff(Surv(time, delta) ~ type, data = df_3)
logrank
peto<-survdiff(Surv(time, delta) ~ type, rho=1, data = df_3)
peto
```
    d. Is the test result in (c) consistent with the plots given in (b)?  
    Yes, the test result weakly fails to reject the null hypothesis and it can be seen in the plot of the estimated survival functions that there is significant overlap in the point-wise confidence intervals.  
  
4. Here we consider...
    a. Import the data into SAS or R and calculate the survival time of interest as the number of days between admission date and follow up date.   
```{r, echo=FALSE, message=FALSE, warning=FALSE}
df = read.csv("pharmacoSmoking-new.csv",
              header = TRUE,
              colClasses = c(rep(NA, 5), "factor", rep(NA, 4), "character", "character", NA, NA)
              )
df = df %>%
  mutate( gender = ifelse(gender==0, "Female", "Male"))

df$admittime = df$admitdate %>%
  as.Date(format = c("%m/%d/%Y"))

df$ftime = df$fdate %>%
  as.Date(format = c("%m/%d/%Y"))

df$time = difftime(df$ftime, df$admittime, units = 'days') %>%
  as.numeric() 

head(df)
```    
  b. For all four groups listed above, plot their survival curves along with their 95% point-wise confidence intervals for survival curves.  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
fit4 <- survfit(Surv(time, relapse) ~ gender + grp, data = df)
ggsurvplot(fit = fit4, data = df, conf.int = TRUE)
```        
  c. Test the hypothesis that there is no difference in survival for patients in four groups. Clearly state the null and alternative hypotheses. Provide the test statistic and conclusions based on these results.  
    H0: there is no difference in survival functions across the four groups of patients.  
    HA: there is a difference in survival functions across the four groups of patients.  
    
    The log-rank test statistic is 11.15 based on 3 degrees of freedom, resulting in a p-value of 0.011.  
    The Peto-Peto test statistic is 8.67 based on 3 degrees of freedom, resulting in a p-value of 0.034.  
    
    All test statistics are in agreement, weakly rejecting the null hypothesis, concluding that there is evidence to find that the survival functions of the groups are statistically different.  
```{r, echo=FALSE, warning=FALSE, message=FALSE}
library("survMisc")
comp(ten(fit4))
```
  
  d. Report pair-wise comparison results to better understand how these four groups are different and summarize your findings.  
    F1: the female combination group differed from F2, the female patch only group.  
    F2: the female patch-only group differed from F1 and M1, the combination groups.  
    M1: the male combination group differed from the female patch-only gruop.  
    M2: the male patch-only group didn't statistically differ from the other groups.  
    
    These findings are consistent with the plot of survival functions: F2 is the most different, although its not substantially different to M2 in earlier times. Its difference to M2 is confined to the later times, when the variance is higher. 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
pairwise_survdiff(Surv(time, relapse) ~ gender + grp, data = df,
                  p.adjust.method = "bonferroni")
```
    

        
### Appendix: R code
```{r ref.label=knitr::all_labels(), echo = T, eval = F}
```
